name: ci-pipeline

on:
  push:
    branches: [ master ]
    paths:
      - 'backend/**'
  

jobs:
# ---------- Code Quality ----------
  codelevel:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
  
  #2 Install Podman & Trivy
      - name: Install Podman
        run: |
          sudo apt-get update
          sudo apt-get install -y podman

      - name: Install Trivy
        uses: aquasecurity/trivy-action@master
        with:
          version: latest
# 3 sonarcloud scan
      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
                  -Dsonar.projectKey=Abdelrazek97_cap-stone-project
                  -Dsonar.organization=abdelrazek97
                  -Dsonar.sources=.
      - name: Fetch Sonar Metrics
        run: |
          mkdir -p reports/sonar
          curl -s -u ${{ secrets.SONAR_TOKEN }}: \
          "https://sonarcloud.io/api/measures/component?component=Abdelrazek97_cap-stone-project&metricKeys=bugs,vulnerabilities,code_smells,coverage" \
          -o reports/sonar/metrics.json
      - name: Generate Sonar Report
        run: |
          echo "# Sonar Metrics" > reports/sonar/report.md
          echo "| Metric | Value |" >> reports/sonar/report.md
          echo "|------|-------|" >> reports/sonar/report.md
          jq -r '.component.measures[] | "| \(.metric) | \(.value) |"' reports/sonar/metrics.json >> reports/sonar/report.md
     
      - uses: actions/upload-artifact@v4
        with:
          name: sonar-report
          path: reports/sonar/

      - name: Check SonarCloud Quality Gate
        run: |
          if grep -q "QUALITY GATE STATUS: FAILED" sonar-report.txt; then
            echo "❌ SonarCloud quality gate failed!"
            exit 1
          else
            echo "✅ SonarCloud quality gate passed."
          fi

      # 4. Build Image with Podman
      - name: Build Container Image
        run: |
          cd backend
          podman build -t ${{ secrets.DOCKERHUB_USERNAME }}-be:${{ github.sha }} .

      # 6. Trivy Scans (Vulnerability + SBOM)
      - name: Run Trivy Vulnerability Scan
        run: |
          trivy image \
            --config trivy-config.yaml \
            --format table \
            --output trivy-vuln-report.txt \
            ${{ secrets.DOCKERHUB_USERNAME }}-be:${{ github.sha }}

      - name: Run Trivy SBOM Scan
        run: |
          trivy sbom \
            --config trivy-config.yaml \
            --format cyclonedx-json \
            --output trivy-sbom-report.json \
            ${{ secrets.DOCKERHUB_USERNAME }}-be:${{ github.sha }}

      - name: Fail on Critical/High Vulnerabilities
        run: |
          trivy image \
            --config trivy-config.yaml \
            --severity CRITICAL,HIGH \
            --exit-code 1 \
            --no-progress \
            ${{ secrets.DOCKERHUB_USERNAME }}-be:${{ github.sha }}

      # 7. Push Image to Docker Hub
      - name: Log in to Docker Hub
        run: |
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | podman login -u ${{ secrets.DOCKERHUB_USERNAME }} --password-stdin docker.io

      - name: Push Image
        run: |
          podman push ${{ secrets.DOCKERHUB_USERNAME }}-be:${{ github.sha }} docker.io/${{ secrets.DOCKERHUB_USERNAME }}-be:${{ github.sha }}
      # 8. Update Kubernetes Manifests
      - name: Update K8s Deployment Image Tag
        run: |
          # Adjust path to your manifest(s)
          sed -i "s|image: ${{ secrets.DOCKERHUB_USERNAME }}-be:[^[:space:]]*|image: ${{ secrets.DOCKERHUB_USERNAME }}-be:${{ github.sha }}|" k8s/deployment.yaml

      - name: Commit Updated Manifest
        run: |
          git config --global user.name 'CI Bot'
          git config --global user.email 'ci-bot@example.com'
          git add k8s/deployment.yaml
          git diff --quiet && echo "No changes" || git commit -m "chore: update image to ${{ github.sha }}"
          git push origin master